<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Kingdoms: Mandate of Heaven - Strategic Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
        }
        .title { 
            font-size: 2em; 
            color: #d4af37; 
            text-align: center; 
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .subtitle {
            text-align: center;
            color: #ccc;
            margin-bottom: 15px;
            font-style: italic;
        }
        .controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px; 
            margin-top: 15px; 
        }
        .btn {
            padding: 8px 12px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }
        .btn:hover { 
            opacity: 0.9; 
            transform: translateY(-2px);
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none;
        }
        .btn.success { background: #28a745; color: white; }
        .btn.primary { background: #007bff; color: white; }
        .btn.info { background: #17a2b8; color: white; }
        .btn.warning { background: #ffc107; color: black; }
        
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d4af37;
        }
        
        .panel h3 {
            color: #d4af37;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .status-grid, .stats-grid, .data-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }
        
        .status-item, .stat-item, .data-item {
            background: rgba(255,255,255,0.1);
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85em;
        }
        
        .status-item.success { 
            background: rgba(40, 167, 69, 0.3); 
            border: 1px solid #28a745;
        }
        
        .status-item.error { 
            background: rgba(220, 53, 69, 0.3); 
            border: 1px solid #dc3545;
        }
        
        .settings {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        select {
            padding: 5px 10px;
            background: #333;
            color: white;
            border: 1px solid #d4af37;
            border-radius: 3px;
        }
        
        .log-panel {
            background: rgba(0,0,0,0.8);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }
        
        .log-entry { 
            padding: 3px 6px; 
            margin: 1px 0; 
            background: rgba(255,255,255,0.05); 
            border-radius: 3px;
            font-size: 0.8em;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.2;
        }
        
        .log-entry.success { 
            background: rgba(40, 167, 69, 0.2); 
            color: #90EE90;
        }
        
        .log-entry.error {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
        }
        
        .log-entry.info {
            background: rgba(23, 162, 184, 0.2);
            color: #87CEEB;
        }
        
        .log-entry.important {
            background: rgba(212,175,55,0.3); 
            font-weight: bold;
            border-left: 3px solid #d4af37;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üèõÔ∏è Three Kingdoms: Mandate of Heaven</h1>
            <p class="subtitle">Strategic Balance Simulator - Using Real Game Data</p>
            
            <div class="settings">
                <label>Players:</label>
                <select id="playerCount">
                    <option value="2">2 Players</option>
                    <option value="3">3 Players</option>
                    <option value="4">4 Players</option>
                </select>
                
                <label>Bulk Games:</label>
                <select id="bulkCount">
                    <option value="10">10 Games</option>
                    <option value="25">25 Games</option>
                    <option value="50">50 Games</option>
                    <option value="100">100 Games</option>
                </select>
                
                <label>Strategy:</label>
                <select id="strategy">
                    <option value="strategic">Strategic AI</option>
                    <option value="balanced">Balanced AI</option>
                    <option value="random">Random AI</option>
                </select>
            </div>
            
            <div class="controls">
                <button class="btn success" id="testModulesBtn">‚úÖ Test Modules</button>
                <button class="btn warning" id="checkDataBtn" disabled>üìÅ Check Data Files</button>
                <button class="btn" id="initBtn" disabled>üéÆ Initialize Engine</button>
                <button class="btn primary" id="quickGameBtn" disabled>‚ö° Quick Game</button>
                <button class="btn primary" id="stepGameBtn" disabled>üë£ Step Game</button>
                <button class="btn info" id="bulkSimBtn" disabled>üìä Bulk Simulation</button>
                <button class="btn" id="exportBtn" disabled>üíæ Export Data</button>
                <button class="btn" id="clearBtn">üóëÔ∏è Clear Logs</button>
            </div>
        </div>

        <div class="panels">
            <div class="panel">
                <h3>üîß System Status</h3>
                <div class="status-grid">
                    <div class="status-item" id="configStatus">Config Module: ‚ùå</div>
                    <div class="status-item" id="playerStatus">Player Module: ‚ùå</div>
                    <div class="status-item" id="gameEngineStatus">Game Engine: ‚ùå</div>
                    <div class="status-item" id="gameStatus">Game Ready: ‚ùå</div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìä Game Data</h3>
                <div class="data-grid">
                    <div class="data-item" id="heroesData">Heroes: <span id="heroCount">Loading...</span></div>
                    <div class="data-item" id="titlesData">Titles: <span id="titleCount">Loading...</span></div>
                    <div class="data-item" id="eventsData">Events: <span id="eventCount">Loading...</span></div>
                    <div class="data-item" id="dataStatus">Data Status: <span id="dataStatusText">Not Loaded</span></div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìà Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">Games Played: <span id="gamesCount">0</span></div>
                    <div class="stat-item">Average Score: <span id="avgScore">-</span></div>
                    <div class="stat-item">Player 1 Wins: <span id="p1Wins">0</span> (<span id="p1Rate">0%</span>)</div>
                    <div class="stat-item">Player 2 Wins: <span id="p2Wins">0</span> (<span id="p2Rate">0%</span>)</div>
                </div>
            </div>
        </div>

        <div class="log-panel">
            <h3 style="color: #d4af37; margin-bottom: 10px;">üìú Simulation Log</h3>
            <div id="logArea"></div>
        </div>
    </div>

    <script type="module">
        // Module tracking and game state
        let moduleStatus = {
            config: false,
            player: false,
            gameEngine: false
        };
        
        let gameEngineInstance = null;
        let dataLoadStatus = {
            heroes: false,
            titles: false,
            events: false
        };
        
        // Make addLog globally available
        window.addLog = function(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.insertBefore(entry, logArea.firstChild);
            
            // Keep only last 150 entries
            while (logArea.children.length > 150) {
                logArea.removeChild(logArea.lastChild);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        };
        
        // Update status displays
        function updateModuleStatus(module, success, message = '') {
            const statusEl = document.getElementById(`${module}Status`);
            if (statusEl) {
                if (success) {
                    statusEl.className = 'status-item success';
                    statusEl.textContent = `${module.charAt(0).toUpperCase() + module.slice(1)} Module: ‚úÖ`;
                    moduleStatus[module] = true;
                } else {
                    statusEl.className = 'status-item error';
                    statusEl.textContent = `${module.charAt(0).toUpperCase() + module.slice(1)} Module: ‚ùå`;
                    moduleStatus[module] = false;
                }
            }
            updateButtonStates();
        }
        
        function updateDataStatus(dataType, count, success = true) {
            const countEl = document.getElementById(`${dataType}Count`);
            const statusEl = document.getElementById('dataStatusText');
            
            if (countEl) {
                countEl.textContent = success ? count : 'Error';
                dataLoadStatus[dataType] = success;
            }
            
            const allDataLoaded = Object.values(dataLoadStatus).every(loaded => loaded);
            if (statusEl) {
                statusEl.textContent = allDataLoaded ? 'All Loaded ‚úÖ' : 'Loading...';
            }
            
            updateButtonStates();
        }
        
        function updateButtonStates() {
            const allModulesLoaded = Object.values(moduleStatus).every(loaded => loaded);
            const allDataLoaded = Object.values(dataLoadStatus).every(loaded => loaded);
            const gameReady = allModulesLoaded && gameEngineInstance !== null;
            
            document.getElementById('checkDataBtn').disabled = !allModulesLoaded;
            document.getElementById('initBtn').disabled = !allModulesLoaded || !allDataLoaded;
            document.getElementById('quickGameBtn').disabled = !gameReady;
            document.getElementById('stepGameBtn').disabled = !gameReady;
            document.getElementById('bulkSimBtn').disabled = !gameReady;
            document.getElementById('exportBtn').disabled = !gameReady;
            
            // Update game status
            const gameStatusEl = document.getElementById('gameStatus');
            if (gameStatusEl) {
                if (gameReady) {
                    gameStatusEl.className = 'status-item success';
                    gameStatusEl.textContent = 'Game Ready: ‚úÖ';
                } else if (allModulesLoaded && allDataLoaded) {
                    gameStatusEl.className = 'status-item';
                    gameStatusEl.textContent = 'Game Ready: ‚ö†Ô∏è Need Init';
                } else {
                    gameStatusEl.className = 'status-item error';
                    gameStatusEl.textContent = 'Game Ready: ‚ùå';
                }
            }
        }
        
        function updateStats() {
            if (!gameEngineInstance) return;
            
            const stats = gameEngineInstance.getStats();
            document.getElementById('gamesCount').textContent = stats.gamesPlayed;
            document.getElementById('avgScore').textContent = stats.averageScore;
            
            const p1Wins = stats.winners['Player 1'] || 0;
            const p2Wins = stats.winners['Player 2'] || 0;
            const totalGames = stats.gamesPlayed;
            
            document.getElementById('p1Wins').textContent = p1Wins;
            document.getElementById('p2Wins').textContent = p2Wins;
            
            if (totalGames > 0) {
                const p1Rate = ((p1Wins / totalGames) * 100).toFixed(1);
                const p2Rate = ((p2Wins / totalGames) * 100).toFixed(1);
                document.getElementById('p1Rate').textContent = `${p1Rate}%`;
                document.getElementById('p2Rate').textContent = `${p2Rate}%`;
            }
        }
        
        // Test module loading
        async function testModuleLoading() {
            addLog('üîç Testing ES6 module loading...', 'info');
            
            try {
                // Test Config
                addLog('Loading config.js...', 'info');
                const configModule = await import('./js/config.js');
                if (!configModule?.GAME_CONFIG) throw new Error('Config missing GAME_CONFIG');
                updateModuleStatus('config', true);
                addLog(`‚úÖ Config loaded: ${Object.keys(configModule.GAME_CONFIG).length} settings`, 'success');
                
                // Test Player
                addLog('Loading player.js...', 'info');
                const playerModule = await import('./js/player.js');
                if (!playerModule?.Player) throw new Error('Player missing Player class');
                updateModuleStatus('player', true);
                addLog('‚úÖ Player class loaded successfully', 'success');
                
                // Test Game Engine
                addLog('Loading game-engine.js...', 'info');
                const gameEngineModule = await import('./js/game-engine.js');
                if (!gameEngineModule?.GameEngine) throw new Error('GameEngine missing GameEngine class');
                updateModuleStatus('gameEngine', true);
                addLog('‚úÖ GameEngine class loaded successfully', 'success');
                
                // Store references globally
                window.ConfigModule = configModule;
                window.PlayerModule = playerModule;
                window.GameEngineModule = gameEngineModule;
                
                addLog('üéâ All modules loaded successfully! Ready to check data files.', 'important');
                
            } catch (error) {
                addLog(`‚ùå Module loading failed: ${error.message}`, 'error');
                console.error('Module loading error:', error);
            }
        }
        
        // Check data files
        async function checkDataFiles() {
            addLog('üìÅ Checking JSON data files...', 'info');
            
            try {
                const dataLoader = window.ConfigModule.dataLoader;
                
                // Check heroes
                addLog('Loading heroes.json...', 'info');
                const heroes = await dataLoader.loadHeroes();
                updateDataStatus('hero', heroes.length, true);
                addLog(`‚úÖ Heroes loaded: ${heroes.length} heroes`, 'success');
                
                // Check titles  
                addLog('Loading titles.json...', 'info');
                const titles = await dataLoader.loadTitles();
                updateDataStatus('title', titles.length, true);
                addLog(`‚úÖ Titles loaded: ${titles.length} titles`, 'success');
                
                // Check events
                addLog('Loading events.json...', 'info');
                const events = await dataLoader.loadEvents();
                updateDataStatus('event', events.length, true);
                addLog(`‚úÖ Events loaded: ${events.length} events`, 'success');
                
                addLog('üéâ All game data loaded successfully! Ready to initialize engine.', 'important');
                
                // Show some sample data for verification
                if (heroes.length > 0) {
                    addLog(`üìä Sample hero: ${heroes[0].name} (${heroes[0].allegiance}) - ${heroes[0].roles?.join(', ') || 'No roles'}`, 'info');
                }
                if (titles.length > 0) {
                    addLog(`üìä Sample title: ${titles[0].name} - ${JSON.stringify(titles[0].cost || {})}`, 'info');
                }
                if (events.length > 0) {
                    addLog(`üìä Sample event: ${events[0].name} (${events[0].leadingResource})`, 'info');
                }
                
            } catch (error) {
                addLog(`‚ùå Data loading failed: ${error.message}`, 'error');
                console.error('Data loading error:', error);
                
                // Update failed data status
                updateDataStatus('hero', 0, false);
                updateDataStatus('title', 0, false);
                updateDataStatus('event', 0, false);
            }
        }
        
        // Initialize game engine
        async function initializeGameEngine() {
            try {
                addLog('üéÆ Initializing game engine with real data...', 'info');
                
                if (!window.GameEngineModule?.GameEngine) {
                    throw new Error('GameEngine module not loaded');
                }
                
                gameEngineInstance = new window.GameEngineModule.GameEngine();
                await gameEngineInstance.initialize();
                
                addLog('üéâ Game engine initialized successfully!', 'success');
                
                // Show data summary
                const stats = gameEngineInstance.getStats();
                if (stats.dataStats) {
                    addLog(`üìä Engine loaded: ${stats.dataStats.heroes} heroes, ${stats.dataStats.titles} titles, ${stats.dataStats.events} events`, 'info');
                }
                
                updateButtonStates();
                
            } catch (error) {
                addLog(`‚ùå Engine initialization failed: ${error.message}`, 'error');
                console.error('Engine initialization error:', error);
            }
        }
        
        // Run quick game
        async function runQuickGame() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized!', 'error');
                return;
            }
            
            try {
                const playerCount = parseInt(document.getElementById('playerCount').value);
                const strategy = document.getElementById('strategy').value;
                
                addLog(`üöÄ Starting quick game: ${playerCount} players, ${strategy} AI...`, 'important');
                
                const startTime = Date.now();
                const results = await gameEngineInstance.runSimulation(1, playerCount, strategy);
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                const result = results[0];
                
                addLog(`üèÜ Game completed in ${duration}s! Winner: ${result.winner} with ${result.winnerScore} points`, 'success');
                result.players.forEach(player => {
                    addLog(`  ${player.name}: ${player.score} pts (${player.titles} titles, ${player.heroes} heroes, ${player.emergencyUsed} emergency)`, 'info');
                });
                
                updateStats();
                
            } catch (error) {
                addLog(`‚ùå Quick game failed: ${error.message}`, 'error');
                console.error('Quick game error:', error);
            }
        }
        
        // Run step game
        async function runStepGame() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized!', 'error');
                return;
            }
            
            try {
                const playerCount = parseInt(document.getElementById('playerCount').value);
                addLog(`üë£ Starting step-by-step game: ${playerCount} players...`, 'important');
                
                const gameState = gameEngineInstance.startNewGame(playerCount);
                addLog(`üéÆ Game initialized. Use Quick Game to complete or run Bulk Simulation.`, 'info');
                
                gameState.players.forEach(player => {
                    const summary = player.getSummary();
                    addLog(`${summary.name}: Hand=${summary.hand} cards, Score=${summary.score}`, 'info');
                });
                
            } catch (error) {
                addLog(`‚ùå Step game failed: ${error.message}`, 'error');
                console.error('Step game error:', error);
            }
        }
        
        // Run bulk simulation
        async function runBulkSimulation() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized!', 'error');
                return;
            }
            
            try {
                const playerCount = parseInt(document.getElementById('playerCount').value);
                const gameCount = parseInt(document.getElementById('bulkCount').value);
                const strategy = document.getElementById('strategy').value;
                
                addLog(`üìä Starting bulk simulation: ${gameCount} games, ${playerCount} players, ${strategy} AI...`, 'important');
                
                const startTime = Date.now();
                const results = await gameEngineInstance.runSimulation(gameCount, playerCount, strategy);
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                
                // Analyze results
                const winners = {};
                const scores = [];
                let totalTitles = 0;
                let totalEmergency = 0;
                
                results.forEach(result => {
                    winners[result.winner] = (winners[result.winner] || 0) + 1;
                    scores.push(result.winnerScore);
                    result.players.forEach(p => {
                        scores.push(p.score);
                        totalTitles += p.titles;
                        totalEmergency += p.emergencyUsed;
                    });
                });
                
                const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                const avgTitles = (totalTitles / (gameCount * playerCount)).toFixed(1);
                const avgEmergency = (totalEmergency / (gameCount * playerCount)).toFixed(1);
                
                addLog(`‚úÖ Bulk simulation completed in ${duration}s (${(gameCount/parseFloat(duration)).toFixed(1)} games/sec)`, 'success');
                addLog(`üìà Average Score: ${avgScore} points, Titles: ${avgTitles}, Emergency: ${avgEmergency}`, 'info');
                
                // Win rate analysis
                const winRates = Object.entries(winners)
                    .map(([player, wins]) => `${player}: ${((wins/gameCount)*100).toFixed(1)}%`)
                    .join(', ');
                addLog(`üèÜ Win Rates: ${winRates}`, 'info');
                
                // Balance analysis
                const winRateValues = Object.values(winners).map(w => (w/gameCount)*100);
                const maxWinRate = Math.max(...winRateValues);
                const minWinRate = Math.min(...winRateValues);
                const variance = maxWinRate - minWinRate;
                
                if (variance <= 10) {
                    addLog(`‚úÖ Excellent balance: Win rate variance ${variance.toFixed(1)}%`, 'success');
                } else if (variance <= 20) {
                    addLog(`‚ö†Ô∏è Good balance: Win rate variance ${variance.toFixed(1)}%`, 'info');
                } else {
                    addLog(`‚ùå Poor balance: Win rate variance ${variance.toFixed(1)}% - needs adjustment`, 'error');
                }
                
                updateStats();
                
            } catch (error) {
                addLog(`‚ùå Bulk simulation failed: ${error.message}`, 'error');
                console.error('Bulk simulation error:', error);
            }
        }
        
        // Export data
        function exportSimulationData() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized!', 'error');
                return;
            }
            
            try {
                const exportData = gameEngineInstance.exportData();
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `three-kingdoms-simulation-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('üíæ Simulation data exported successfully!', 'success');
                addLog(`üìä Export included ${exportData.stats.gamesPlayed} games of data`, 'info');
                
            } catch (error) {
                addLog(`‚ùå Export failed: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        }
        
        // Clear logs
        function clearAllLogs() {
            document.getElementById('logArea').innerHTML = '';
            addLog('üóëÔ∏è Logs cleared - simulator ready', 'info');
        }
        
        // Event listeners
        document.getElementById('testModulesBtn').addEventListener('click', testModuleLoading);
        document.getElementById('checkDataBtn').addEventListener('click', checkDataFiles);
        document.getElementById('initBtn').addEventListener('click', initializeGameEngine);
        document.getElementById('quickGameBtn').addEventListener('click', runQuickGame);
        document.getElementById('stepGameBtn').addEventListener('click', runStepGame);
        document.getElementById('bulkSimBtn').addEventListener('click', runBulkSimulation);
        document.getElementById('exportBtn').addEventListener('click', exportSimulationData);
        document.getElementById('clearBtn').addEventListener('click', clearAllLogs);
        
        // Initialize on page load
        window.addEventListener('load', function() {
            addLog('üèõÔ∏è Three Kingdoms Strategic Simulator loaded - Real Game Data Version', 'success');
            addLog('üìã Follow these steps:', 'info');
            addLog('1Ô∏è‚É£ Click "‚úÖ Test Modules" to verify ES6 modules', 'info');
            addLog('2Ô∏è‚É£ Click "üìÅ Check Data Files" to load JSON data', 'info');
            addLog('3Ô∏è‚É£ Click "üéÆ Initialize Engine" to prepare for simulation', 'info');
            addLog('4Ô∏è‚É£ Use "‚ö° Quick Game" or "üìä Bulk Simulation" to test balance!', 'info');
            updateButtonStates();
        });
        
    </script>
</body>
</html>
