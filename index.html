<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Kingdoms: Debug Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .header {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
        }
        .title { 
            font-size: 2em; 
            color: #d4af37; 
            text-align: center; 
            margin-bottom: 15px;
        }
        .controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px; 
            margin-top: 15px; 
        }
        .btn {
            padding: 8px 12px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.success { background: #28a745; color: white; }
        .btn.danger { background: #dc3545; color: white; }
        .btn.primary { background: #007bff; color: white; }
        
        .panel {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .debug-panel {
            border: 2px solid #ff6b6b;
        }
        
        .game-panel {
            border: 2px solid #d4af37;
        }
        
        .stats-panel {
            border: 2px solid #28a745;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .status-item.success { 
            background: rgba(40, 167, 69, 0.3); 
            border: 1px solid #28a745;
        }
        
        .status-item.error { 
            background: rgba(220, 53, 69, 0.3); 
            border: 1px solid #dc3545;
        }
        
        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-box {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .player-card {
            background: rgba(0,0,0,0.6);
            border: 1px solid #d4af37;
            border-radius: 8px;
            padding: 12px;
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #666;
        }
        
        .resource-display {
            display: flex;
            gap: 8px;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .log-panel {
            background: rgba(0,0,0,0.8);
            border: 2px solid #6c757d;
            border-radius: 10px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
        }
        
        .log-entry { 
            padding: 3px 6px; 
            margin: 1px 0; 
            background: rgba(255,255,255,0.05); 
            border-radius: 3px;
            font-size: 0.8em;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .log-entry.success { 
            background: rgba(40, 167, 69, 0.2); 
            color: #90EE90;
        }
        
        .log-entry.error {
            background: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
        }
        
        .log-entry.debug {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }
        
        .log-entry.important {
            background: rgba(212,175,55,0.3); 
            font-weight: bold;
            border-left: 3px solid #d4af37;
        }
        
        .log-entry.game {
            background: rgba(0, 123, 255, 0.2);
            color: #87ceeb;
        }

        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        select {
            padding: 5px 8px;
            background: #333;
            color: white;
            border: 1px solid #d4af37;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üêõ Three Kingdoms: Debug Simulator</h1>
            <div class="controls">
                <button class="btn success" id="testModulesBtn">‚úÖ Test Modules</button>
                <button class="btn" id="checkDataBtn" disabled>üìÅ Check Data</button>
                <button class="btn" id="initBtn" disabled>üéÆ Initialize</button>
                <button class="btn primary" id="newGameBtn" disabled>üéØ New Game</button>
                <button class="btn primary" id="stepBtn" disabled>üëâ Next Step</button>
                <button class="btn primary" id="autoBtn" disabled>‚ö° Auto Game</button>
                <button class="btn" id="bulkBtn" disabled>üìä Bulk Sim</button>
                <button class="btn" id="debugBtn">üêõ Debug</button>
                <button class="btn danger" id="clearBtn">üóëÔ∏è Clear</button>
            </div>
        </div>

        <div class="panel debug-panel">
            <h3 style="color: #ff6b6b; margin-bottom: 10px;">üêõ System Status</h3>
            <div class="status-grid">
                <div class="status-item" id="configStatus">Config: ‚ùå</div>
                <div class="status-item" id="playerStatus">Player: ‚ùå</div>
                <div class="status-item" id="gameEngineStatus">Engine: ‚ùå</div>
                <div class="status-item" id="heroesStatus">Heroes: ‚ùå</div>
                <div class="status-item" id="titlesStatus">Titles: ‚ùå</div>
                <div class="status-item" id="eventsStatus">Events: ‚ùå</div>
                <div class="status-item" id="initBtnStatus">Init Button: ‚ùå Disabled</div>
                <div class="status-item" id="gameStatus">Game: ‚ùå Not Started</div>
            </div>
        </div>

        <div class="panel game-panel" id="gamePanel">
            <h3 style="color: #d4af37; margin-bottom: 10px;">üéÆ Game Configuration</h3>
            <div class="config-section">
                <div>
                    <label>Players:</label>
                    <select id="playerCount">
                        <option value="2">2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4">4 Players</option>
                    </select>
                </div>
                <div>
                    <label>AI Strategy:</label>
                    <select id="aiStrategy">
                        <option value="strategic">Strategic</option>
                        <option value="balanced">Balanced</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
                <div>
                    <label>Bulk Games:</label>
                    <select id="bulkCount">
                        <option value="10">10 Games</option>
                        <option value="50">50 Games</option>
                        <option value="100">100 Games</option>
                        <option value="500">500 Games</option>
                    </select>
                </div>
            </div>
            
            <div class="game-info">
                <div class="info-box">
                    <h4 style="color: #d4af37;">Current Game</h4>
                    <p>Turn: <span id="turnNum">-</span> / 8</p>
                    <p>Phase: <span id="currentPhase">-</span></p>
                    <p>Event: <span id="currentEvent">-</span></p>
                </div>
                <div class="info-box">
                    <h4 style="color: #d4af37;">Markets</h4>
                    <p>Heroes: <span id="heroMarket">-</span></p>
                    <p>Titles: <span id="titleMarket">-</span></p>
                    <p>Turn Order: <span id="turnOrder">-</span></p>
                </div>
            </div>
            
            <div class="player-grid" id="playerGrid">
                <!-- Players will be populated here -->
            </div>
        </div>

        <div class="panel stats-panel" id="statsPanel">
            <h3 style="color: #28a745; margin-bottom: 10px;">üìä Statistics</h3>
            <div class="status-grid">
                <div class="status-item">Games: <span id="gamesPlayed">0</span></div>
                <div class="status-item">Avg Score: <span id="avgScore">-</span></div>
                <div class="status-item">Win Rate: <span id="winRate">-</span></div>
                <div class="status-item">Avg Emergency: <span id="avgEmergency">-</span></div>
                <div class="status-item">Pass Rate: <span id="passRate">-</span></div>
                <div class="status-item">Titles/Game: <span id="avgTitles">-</span></div>
            </div>
        </div>

        <div class="log-panel">
            <h3 style="color: #6c757d; margin-bottom: 10px;">üìú Activity Log</h3>
            <div id="logArea"></div>
        </div>
    </div>

    <script type="module">
        // Debug tracking
        let debugState = {
            modules: {
                config: false,
                player: false,
                gameEngine: false
            },
            data: {
                heroes: false,
                titles: false,
                events: false
            },
            buttonLogic: {
                allModulesLoaded: false,
                allDataLoaded: false,
                shouldEnable: false
            },
            game: {
                engineReady: false,
                gameActive: false
            }
        };
        
        let gameEngineInstance = null;
        let gameStats = {
            gamesPlayed: 0,
            totalScores: [],
            totalEmergency: 0,
            totalPasses: 0,
            totalTitles: 0,
            playerWins: {}
        };
        
        // Enhanced logging with game-specific support
        window.addLog = function(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.insertBefore(entry, logArea.firstChild);
            
            while (logArea.children.length > 200) {
                logArea.removeChild(logArea.lastChild);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        };
        
        function debugLog(message) {
            addLog(`üêõ DEBUG: ${message}`, 'debug');
        }
        
        function gameLog(message) {
            addLog(`üéÆ GAME: ${message}`, 'game');
        }
        
        // Enhanced status update
        function updateStatus(category, item, success, count = null) {
            const statusEl = document.getElementById(`${item}Status`);
            if (statusEl) {
                if (success) {
                    statusEl.className = 'status-item success';
                    const countText = count !== null ? ` (${count})` : '';
                    statusEl.textContent = `${item.charAt(0).toUpperCase() + item.slice(1)}: ‚úÖ${countText}`;
                } else {
                    statusEl.className = 'status-item error';
                    statusEl.textContent = `${item.charAt(0).toUpperCase() + item.slice(1)}: ‚ùå`;
                }
            }
            
            // Update debug state
            if (debugState[category]) {
                debugState[category][item] = success;
                debugLog(`${category}.${item} = ${success}`);
            }
            
            updateButtonLogic();
        }
        
        // Enhanced button logic with game state
        function updateButtonLogic() {
            const allModulesLoaded = Object.values(debugState.modules).every(loaded => loaded);
            const allDataLoaded = Object.values(debugState.data).every(loaded => loaded);
            const shouldEnable = allModulesLoaded && allDataLoaded;
            const gameReady = debugState.game.engineReady;
            const gameActive = debugState.game.gameActive;
            
            // Update debug state
            debugState.buttonLogic = {
                allModulesLoaded,
                allDataLoaded,
                shouldEnable
            };
            
            // Update button states
            document.getElementById('checkDataBtn').disabled = !allModulesLoaded;
            document.getElementById('initBtn').disabled = !shouldEnable;
            document.getElementById('newGameBtn').disabled = !gameReady;
            document.getElementById('stepBtn').disabled = !gameActive;
            document.getElementById('autoBtn').disabled = !gameActive;
            document.getElementById('bulkBtn').disabled = !gameReady || gameActive;
            
            // Update status displays
            const initBtnEl = document.getElementById('initBtnStatus');
            const gameStatusEl = document.getElementById('gameStatus');
            
            if (initBtnEl) {
                if (shouldEnable) {
                    initBtnEl.className = 'status-item success';
                    initBtnEl.textContent = 'Init Button: ‚úÖ Enabled';
                } else {
                    initBtnEl.className = 'status-item error';
                    initBtnEl.textContent = 'Init Button: ‚ùå Disabled';
                }
            }
            
            if (gameStatusEl) {
                if (gameActive) {
                    gameStatusEl.className = 'status-item success';
                    gameStatusEl.textContent = 'Game: ‚úÖ Active';
                } else if (gameReady) {
                    gameStatusEl.className = 'status-item';
                    gameStatusEl.textContent = 'Game: üéÆ Ready';
                } else {
                    gameStatusEl.className = 'status-item error';
                    gameStatusEl.textContent = 'Game: ‚ùå Not Ready';
                }
            }
        }
        
        // Test modules with enhanced debugging
        async function testModuleLoading() {
            addLog('üîç Testing module loading...', 'important');
            
            try {
                // Test Config
                addLog('Loading config.js...', 'info');
                const configModule = await import('./js/config.js');
                if (!configModule?.GAME_CONFIG) throw new Error('Config missing GAME_CONFIG');
                updateStatus('modules', 'config', true);
                addLog(`‚úÖ Config loaded: ${Object.keys(configModule.GAME_CONFIG).length} settings`, 'success');
                
                // Test Player
                addLog('Loading player.js...', 'info');
                const playerModule = await import('./js/player.js');
                if (!playerModule?.Player) throw new Error('Player missing Player class');
                updateStatus('modules', 'player', true);
                addLog('‚úÖ Player class loaded', 'success');
                
                // Test Game Engine
                addLog('Loading game-engine.js...', 'info');
                const gameEngineModule = await import('./js/game-engine.js');
                if (!gameEngineModule?.GameEngine) throw new Error('GameEngine missing GameEngine class');
                updateStatus('modules', 'gameEngine', true);
                addLog('‚úÖ GameEngine class loaded', 'success');
                
                // Store globally
                window.ConfigModule = configModule;
                window.PlayerModule = playerModule;
                window.GameEngineModule = gameEngineModule;
                
                addLog('üéâ All modules loaded successfully!', 'important');
                
            } catch (error) {
                addLog(`‚ùå Module loading failed: ${error.message}`, 'error');
                debugLog(`Module error details: ${error.stack}`);
            }
        }
        
        // Check data with enhanced debugging
        async function checkDataFiles() {
            addLog('üìÅ Checking data files...', 'important');
            
            try {
                if (!window.ConfigModule?.dataLoader) {
                    throw new Error('DataLoader not available - modules not loaded properly');
                }
                
                const dataLoader = window.ConfigModule.dataLoader;
                
                // Check heroes
                addLog('Loading heroes.json...', 'info');
                const heroes = await dataLoader.loadHeroes();
                updateStatus('data', 'heroes', true, heroes.length);
                addLog(`‚úÖ Heroes: ${heroes.length} loaded`, 'success');
                
                // Check titles
                addLog('Loading titles.json...', 'info');
                const titles = await dataLoader.loadTitles();
                updateStatus('data', 'titles', true, titles.length);
                addLog(`‚úÖ Titles: ${titles.length} loaded`, 'success');
                
                // Check events
                addLog('Loading events.json...', 'info');
                const events = await dataLoader.loadEvents();
                updateStatus('data', 'events', true, events.length);
                addLog(`‚úÖ Events: ${events.length} loaded`, 'success');
                
                addLog('üéâ All data files loaded successfully!', 'important');
                
            } catch (error) {
                addLog(`‚ùå Data loading failed: ${error.message}`, 'error');
                debugLog(`Data error details: ${error.stack}`);
                
                // Mark all data as failed
                updateStatus('data', 'heroes', false);
                updateStatus('data', 'titles', false);
                updateStatus('data', 'events', false);
            }
        }
        
        // Initialize with debugging
        async function initializeEngine() {
            addLog('üéÆ Initializing game engine...', 'important');
            
            try {
                if (!window.GameEngineModule?.GameEngine) {
                    throw new Error('GameEngine not loaded');
                }
                
                gameEngineInstance = new window.GameEngineModule.GameEngine();
                await gameEngineInstance.initialize();
                
                debugState.game.engineReady = true;
                addLog('‚úÖ Game engine initialized!', 'success');
                updateButtonLogic();
                
            } catch (error) {
                addLog(`‚ùå Engine init failed: ${error.message}`, 'error');
                debugLog(`Engine error details: ${error.stack}`);
            }
        }
        
        // New game
        async function startNewGame() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized', 'error');
                return;
            }
            
            try {
                const playerCount = parseInt(document.getElementById('playerCount').value);
                const aiStrategy = document.getElementById('aiStrategy').value;
                
                gameLog(`Starting new ${playerCount}-player game with ${aiStrategy} AI`);
                
                await gameEngineInstance.startNewGame(playerCount, aiStrategy);
                debugState.game.gameActive = true;
                
                updateGameDisplay();
                updateButtonLogic();
                
                gameLog('üéØ New game started successfully!');
                
            } catch (error) {
                addLog(`‚ùå Failed to start game: ${error.message}`, 'error');
                debugLog(`Game start error: ${error.stack}`);
            }
        }
        
        // Next step
        async function nextStep() {
            if (!gameEngineInstance || !debugState.game.gameActive) {
                addLog('‚ùå No active game', 'error');
                return;
            }
            
            try {
                const result = await gameEngineInstance.nextStep();
                
                updateGameDisplay();
                
                if (result.gameEnded) {
                    debugState.game.gameActive = false;
                    updateButtonLogic();
                    updateStats(result);
                    gameLog(`üèÜ Game ended! Winner: ${result.winner?.name || 'Unknown'}`);
                }
                
            } catch (error) {
                addLog(`‚ùå Step failed: ${error.message}`, 'error');
                debugLog(`Step error: ${error.stack}`);
            }
        }
        
        // Auto play game
        async function autoPlayGame() {
            if (!gameEngineInstance || !debugState.game.gameActive) {
                addLog('‚ùå No active game', 'error');
                return;
            }
            
            gameLog('‚ö° Running game automatically...');
            
            while (debugState.game.gameActive) {
                await nextStep();
                await new Promise(resolve => setTimeout(resolve, 10)); // Small delay for UI
            }
        }
        
        // Bulk simulation
        async function runBulkSimulation() {
            if (!gameEngineInstance) {
                addLog('‚ùå Game engine not initialized', 'error');
                return;
            }
            
            const bulkCount = parseInt(document.getElementById('bulkCount').value);
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const aiStrategy = document.getElementById('aiStrategy').value;
            
            addLog(`üìä Starting bulk simulation: ${bulkCount} games`, 'important');
            
            const startTime = Date.now();
            
            for (let i = 0; i < bulkCount; i++) {
                try {
                    await gameEngineInstance.startNewGame(playerCount, aiStrategy);
                    debugState.game.gameActive = true;
                    
                    // Run full game
                    while (debugState.game.gameActive) {
                        const result = await gameEngineInstance.nextStep();
                        
                        if (result.gameEnded) {
                            debugState.game.gameActive = false;
                            updateStats(result);
                        }
                    }
                    
                    if ((i + 1) % 10 === 0) {
                        addLog(`üìä Progress: ${i + 1}/${bulkCount} games completed`, 'info');
                        updateStatsDisplay();
                    }
                    
                } catch (error) {
                    addLog(`‚ùå Game ${i + 1} failed: ${error.message}`, 'error');
                }
            }
            
            const endTime = Date.now();
            const duration = (endTime - startTime) / 1000;
            const gamesPerSecond = bulkCount / duration;
            
            addLog(`‚úÖ Bulk simulation complete: ${bulkCount} games in ${duration.toFixed(1)}s (${gamesPerSecond.toFixed(1)} games/sec)`, 'success');
            updateStatsDisplay();
        }
        
        // Update game display
        function updateGameDisplay() {
            if (!gameEngineInstance?.gameState) return;
            
            const state = gameEngineInstance.gameState;
            
            // Update basic info
            document.getElementById('turnNum').textContent = state.turn || '-';
            document.getElementById('currentPhase').textContent = state.phase || '-';
            document.getElementById('currentEvent').textContent = state.currentEvent?.name || '-';
            document.getElementById('heroMarket').textContent = state.heroMarket?.length || '-';
            document.getElementById('titleMarket').textContent = state.titleMarket?.length || '-';
            document.getElementById('turnOrder').textContent = state.turnOrder?.map(p => `P${p.id + 1}`).join(' ‚Üí ') || '-';
            
            // Update players
            const playerGrid = document.getElementById('playerGrid');
            playerGrid.innerHTML = '';
            
            if (state.players) {
                state.players.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-card';
                    
                    const resources = player.calculateBattlefieldResources ? player.calculateBattlefieldResources() : 
                                    { military: 0, influence: 0, supplies: 0, piety: 0 };
                    
                    const totalHeroes = player.getAllHeroes ? player.getAllHeroes().length : 0;
                    const titles = player.titles ? player.titles.length : 0;
                    
                    playerDiv.innerHTML = `
                        <div class="player-header">
                            <h4 style="color: #d4af37;">Player ${index + 1}</h4>
                            <span style="color: #ffd700;">Score: ${player.score || 0}</span>
                        </div>
                        <p>Hand: ${player.hand?.length || 0} | Titles: ${titles} | Heroes: ${totalHeroes}</p>
                        <div class="resource-display">
                            <span>‚öîÔ∏è${resources.military}</span>
                            <span>üìú${resources.influence}</span>
                            <span>üì¶${resources.supplies}</span>
                            <span>üèõÔ∏è${resources.piety}</span>
                        </div>
                        <p style="font-size: 0.8em; margin-top: 5px;">Emergency: ${player.emergencyUsed || 0}</p>
                    `;
                    
                    playerGrid.appendChild(playerDiv);
                });
            }
        }
        
        // Update statistics
        function updateStats(result) {
            gameStats.gamesPlayed++;
            
            if (result.players) {
                result.players.forEach((player, index) => {
                    gameStats.totalScores.push(player.score || 0);
                    gameStats.totalEmergency += player.emergencyUsed || 0;
                    gameStats.totalTitles += player.titles?.length || 0;
                    
                    if (!gameStats.playerWins[index]) {
                        gameStats.playerWins[index] = 0;
                    }
                });
                
                // Track winner
                if (result.winner) {
                    const winnerIndex = result.players.indexOf(result.winner);
                    if (winnerIndex !== -1) {
                        gameStats.playerWins[winnerIndex]++;
                    }
                }
            }
            
            if (result.passes) {
                gameStats.totalPasses += result.passes;
            }
        }
        
        // Update statistics display
        function updateStatsDisplay() {
            document.getElementById('gamesPlayed').textContent = gameStats.gamesPlayed;
            
            if (gameStats.gamesPlayed > 0) {
                const avgScore = gameStats.totalScores.reduce((a, b) => a + b, 0) / gameStats.totalScores.length;
                document.getElementById('avgScore').textContent = avgScore.toFixed(1);
                
                const avgEmergency = gameStats.totalEmergency / gameStats.gamesPlayed;
                document.getElementById('avgEmergency').textContent = avgEmergency.toFixed(1);
                
                const avgTitles = gameStats.totalTitles / gameStats.gamesPlayed;
                document.getElementById('avgTitles').textContent = avgTitles.toFixed(1);
                
                const totalActions = gameStats.gamesPlayed * 8; // 8 turns per game
                const passRate = (gameStats.totalPasses / totalActions * 100).toFixed(1);
                document.getElementById('passRate').textContent = `${passRate}%`;
                
                // Win rate (for player 1)
                const p1Wins = gameStats.playerWins[0] || 0;
                const winRate = (p1Wins / gameStats.gamesPlayed * 100).toFixed(1);
                document.getElementById('winRate').textContent = `${winRate}%`;
            }
        }
        
        // Debug status dump
        function debugStatus() {
            addLog('üêõ === DEBUG STATUS DUMP ===', 'debug');
            addLog(`Debug State: ${JSON.stringify(debugState, null, 2)}`, 'debug');
            addLog(`Window objects: ConfigModule=${!!window.ConfigModule}, PlayerModule=${!!window.PlayerModule}, GameEngineModule=${!!window.GameEngineModule}`, 'debug');
            addLog(`Game instance: ${!!gameEngineInstance}`, 'debug');
            
            if (gameEngineInstance?.gameState) {
                const state = gameEngineInstance.gameState;
                addLog(`Game state - Turn: ${state.turn}, Phase: ${state.phase}, Players: ${state.players?.length}`, 'debug');
                addLog(`Markets - Heroes: ${state.heroMarket?.length}, Titles: ${state.titleMarket?.length}`, 'debug');
            } else {
                addLog('No active game state', 'debug');
            }
            
            // Check button element states
            const buttons = ['initBtn', 'newGameBtn', 'stepBtn', 'autoBtn', 'bulkBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                addLog(`Button ${btnId}: disabled=${btn?.disabled}, exists=${!!btn}`, 'debug');
            });
            
            // Manual logic check
            const manualModulesCheck = Object.values(debugState.modules).every(loaded => loaded);
            const manualDataCheck = Object.values(debugState.data).every(loaded => loaded);
            addLog(`Manual check - Modules: ${manualModulesCheck}, Data: ${manualDataCheck}`, 'debug');
            
            // Game stats
            addLog(`Game stats: ${JSON.stringify(gameStats, null, 2)}`, 'debug');
        }
        
        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
            addLog('üóëÔ∏è Logs cleared - ready for debugging', 'info');
        }
        
        function clearAllStats() {
            gameStats = {
                gamesPlayed: 0,
                totalScores: [],
                totalEmergency: 0,
                totalPasses: 0,
                totalTitles: 0,
                playerWins: {}
            };
            updateStatsDisplay();
            addLog('üìä All statistics cleared', 'info');
        }
        
        // Mock game engine for testing if real one isn't available
        function createMockGameEngine() {
            return {
                gameState: {
                    turn: 1,
                    phase: 'deployment',
                    currentEvent: { name: 'Mock Event', leadingResource: 'military' },
                    players: [
                        {
                            id: 0,
                            name: 'Player 1',
                            score: 5,
                            hand: [{}, {}, {}],
                            titles: [],
                            emergencyUsed: 0,
                            calculateBattlefieldResources: () => ({ military: 3, influence: 2, supplies: 1, piety: 2 }),
                            getAllHeroes: () => [{name: 'Mock Hero'}]
                        },
                        {
                            id: 1,
                            name: 'Player 2',
                            score: 7,
                            hand: [{}, {}, {}, {}],
                            titles: [{name: 'Mock Title'}],
                            emergencyUsed: 1,
                            calculateBattlefieldResources: () => ({ military: 2, influence: 3, supplies: 3, piety: 1 }),
                            getAllHeroes: () => [{name: 'Mock Hero 1'}, {name: 'Mock Hero 2'}]
                        }
                    ],
                    heroMarket: [{}, {}, {}, {}],
                    titleMarket: [{}, {}, {}, {}],
                    turnOrder: []
                },
                
                async initialize() {
                    addLog('üéÆ Mock engine initialized', 'success');
                    return true;
                },
                
                async startNewGame(playerCount, strategy) {
                    addLog(`üéØ Mock game started: ${playerCount} players, ${strategy} strategy`, 'game');
                    this.gameState.players = Array.from({length: playerCount}, (_, i) => ({
                        id: i,
                        name: `Player ${i + 1}`,
                        score: Math.floor(Math.random() * 20),
                        hand: Array.from({length: Math.floor(Math.random() * 5) + 1}, () => ({})),
                        titles: Array.from({length: Math.floor(Math.random() * 3)}, () => ({name: `Title ${Math.floor(Math.random() * 10)}`})),
                        emergencyUsed: Math.floor(Math.random() * 3),
                        calculateBattlefieldResources: () => ({
                            military: Math.floor(Math.random() * 5),
                            influence: Math.floor(Math.random() * 5),
                            supplies: Math.floor(Math.random() * 5),
                            piety: Math.floor(Math.random() * 5)
                        }),
                        getAllHeroes: () => Array.from({length: Math.floor(Math.random() * 8) + 2}, (_, j) => ({name: `Hero ${j}`}))
                    }));
                    this.gameState.turn = 1;
                    this.gameState.phase = 'deployment';
                    return true;
                },
                
                async nextStep() {
                    const phases = ['deployment', 'reveal', 'purchase', 'cleanup'];
                    const currentPhaseIndex = phases.indexOf(this.gameState.phase);
                    
                    if (currentPhaseIndex < phases.length - 1) {
                        this.gameState.phase = phases[currentPhaseIndex + 1];
                        gameLog(`Phase changed to: ${this.gameState.phase}`);
                    } else {
                        this.gameState.turn++;
                        this.gameState.phase = 'deployment';
                        gameLog(`Turn ${this.gameState.turn} started`);
                        
                        // Update player scores randomly
                        this.gameState.players.forEach(player => {
                            player.score += Math.floor(Math.random() * 3);
                        });
                    }
                    
                    if (this.gameState.turn > 8) {
                        // Game ended
                        const winner = this.gameState.players.reduce((best, player) => 
                            player.score > best.score ? player : best
                        );
                        
                        return {
                            gameEnded: true,
                            winner: winner,
                            players: this.gameState.players,
                            passes: Math.floor(Math.random() * 5)
                        };
                    }
                    
                    return { gameEnded: false };
                }
            };
        }
        
        // Enhanced initialize that falls back to mock if needed
        async function initializeEngineWithFallback() {
            try {
                await initializeEngine();
            } catch (error) {
                addLog(`‚ö†Ô∏è Real engine failed, using mock engine for testing`, 'debug');
                gameEngineInstance = createMockGameEngine();
                await gameEngineInstance.initialize();
                debugState.game.engineReady = true;
                updateButtonLogic();
            }
        }
        
        // Event listeners
        document.getElementById('testModulesBtn').addEventListener('click', testModuleLoading);
        document.getElementById('checkDataBtn').addEventListener('click', checkDataFiles);
        document.getElementById('initBtn').addEventListener('click', initializeEngineWithFallback);
        document.getElementById('newGameBtn').addEventListener('click', startNewGame);
        document.getElementById('stepBtn').addEventListener('click', nextStep);
        document.getElementById('autoBtn').addEventListener('click', autoPlayGame);
        document.getElementById('bulkBtn').addEventListener('click', runBulkSimulation);
        document.getElementById('debugBtn').addEventListener('click', debugStatus);
        document.getElementById('clearBtn').addEventListener('click', () => {
            clearLogs();
            clearAllStats();
        });
        
        // Initialize
        window.addEventListener('load', function() {
            addLog('üêõ Debug simulator loaded - enhanced logging enabled', 'important');
            addLog('Click buttons in order: Test Modules ‚Üí Check Data ‚Üí Initialize ‚Üí New Game', 'info');
            addLog('Use "üêõ Debug" anytime to see detailed state information', 'info');
            updateButtonLogic();
            updateStatsDisplay();
        });
        
    </script>
</body>
</html>
