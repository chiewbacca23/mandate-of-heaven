<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Kingdoms: Monte Carlo Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 10px;
        }

        .status.ready {
            background: #2ecc71;
            color: #fff;
        }

        .status.loading {
            background: #f39c12;
            color: #fff;
        }

        .status.error {
            background: #e74c3c;
            color: #fff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel, .results-panel, .log-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 25px;
        }

        .control-panel {
            height: fit-content;
        }

        h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95em;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #2ecc71;
            color: #fff;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
            color: #fff;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .log-panel {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
            border-left: 4px solid #3498db;
        }

        .log-entry.success {
            background: rgba(46, 204, 113, 0.2);
            border-left-color: #2ecc71;
        }

        .log-entry.info {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #3498db;
        }

        .log-entry.warning {
            background: rgba(243, 156, 18, 0.2);
            border-left-color: #f39c12;
        }

        .log-entry.error {
            background: rgba(231, 76, 60, 0.2);
            border-left-color: #e74c3c;
        }

        .title-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .title-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .title-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .title-stats {
            opacity: 0.8;
            font-size: 0.9em;
        }

        #log {
            font-family: 'Courier New', monospace;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è Three Kingdoms: Mandate of Heaven</h1>
            <div class="subtitle">Monte Carlo Balance Simulator</div>
            <div id="systemStatus" class="status loading">System Loading...</div>
        </header>

        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <h2>üéÆ Controls</h2>
                
                <div class="control-group">
                    <button id="btnLoadData" class="btn-primary">üìÅ Load Game Data</button>
                </div>

                <div class="control-group">
                    <label for="playerCount">Players:</label>
                    <select id="playerCount">
                        <option value="2" selected>2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4">4 Players</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="gameCount">Simulation Size:</label>
                    <select id="gameCount">
                        <option value="1">1 Game (Test)</option>
                        <option value="10">10 Games</option>
                        <option value="50">50 Games</option>
                        <option value="100" selected>100 Games</option>
                        <option value="500">500 Games</option>
                        <option value="1000">1000 Games</option>
                    </select>
                </div>

                <div class="control-group">
                    <button id="btnRunSim" class="btn-success" disabled>‚ñ∂Ô∏è Run Simulation</button>
                    <button id="btnClearResults" class="btn-warning">üóëÔ∏è Clear Results</button>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <h2>üìä Results</h2>
                
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill">0%</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Games Completed</div>
                        <div id="gamesCompleted" class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Score</div>
                        <div id="avgScore" class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Win Rate (P1)</div>
                        <div id="winRateP1" class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Emergency Used</div>
                        <div id="avgEmergency" class="stat-value">-</div>
                    </div>
                </div>

                <div id="detailedStats" class="hidden">
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Win Rate by Position</h3>
                    <div id="winRateBreakdown" class="stats-grid"></div>

                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Title Acquisition Rates</h3>
                    <div id="titleStats" class="title-list"></div>
                </div>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="log-panel">
            <h2>üìú Activity Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <script type="module">
        // Import the purchase manager
        import { PurchaseManager } from './js/purchase-manager.js';

        // Global state
        let gameData = {
            heroes: null,
            titles: null,
            events: null,
            provincialUnits: null
        };
        let purchaseManager = null;
        let simulationStats = {
            gamesCompleted: 0,
            totalScores: [],
            winsByPosition: {},
            emergencyUsage: [],
            titleAcquisitions: {}
        };
        let isRunning = false;

        // DOM elements
        const btnLoadData = document.getElementById('btnLoadData');
        const btnRunSim = document.getElementById('btnRunSim');
        const btnClearResults = document.getElementById('btnClearResults');
        const systemStatus = document.getElementById('systemStatus');
        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');

        // Logging function
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Load game data
        async function loadGameData() {
            try {
                log('Loading game data...', 'info');
                btnLoadData.disabled = true;
                btnLoadData.innerHTML = '<span class="spinner"></span>Loading...';

                // Load all data files
                const [heroes, titles, events, provincialUnits] = await Promise.all([
                    fetch('./data/heroes.json').then(r => r.json()),
                    fetch('./data/titles.json').then(r => r.json()),
                    fetch('./data/events.json').then(r => r.json()),
                    fetch('./data/provincial_units.json').then(r => r.json())
                ]);

                gameData.heroes = heroes;
                gameData.titles = titles;
                gameData.events = events;
                gameData.provincialUnits = provincialUnits;

                // Initialize purchase manager
                purchaseManager = new PurchaseManager(heroes, titles, events);

                log(`‚úÖ Loaded ${heroes.length} heroes`, 'success');
                log(`‚úÖ Loaded ${titles.length} titles`, 'success');
                log(`‚úÖ Loaded ${events.length} events`, 'success');
                log(`‚úÖ Loaded ${provincialUnits.length} provincial units`, 'success');
                log('‚úÖ Purchase Manager initialized', 'success');

                systemStatus.textContent = '‚úÖ System Ready';
                systemStatus.className = 'status ready';
                btnLoadData.innerHTML = '‚úÖ Data Loaded';
                btnRunSim.disabled = false;

            } catch (error) {
                log(`‚ùå Error loading data: ${error.message}`, 'error');
                systemStatus.textContent = '‚ùå Load Failed';
                systemStatus.className = 'status error';
                btnLoadData.disabled = false;
                btnLoadData.innerHTML = 'üìÅ Retry Load';
            }
        }

        // Run simulation
        async function runSimulation() {
            if (isRunning) return;

            const playerCount = parseInt(document.getElementById('playerCount').value);
            const gameCount = parseInt(document.getElementById('gameCount').value);

            log(`Starting ${gameCount} game simulation with ${playerCount} players...`, 'info');
            isRunning = true;
            btnRunSim.disabled = true;
            btnRunSim.innerHTML = '<span class="spinner"></span>Running...';

            // Reset stats
            simulationStats = {
                gamesCompleted: 0,
                totalScores: [],
                winsByPosition: {},
                emergencyUsage: [],
                titleAcquisitions: {}
            };

            for (let i = 1; i <= playerCount; i++) {
                simulationStats.winsByPosition[i] = 0;
            }

            // Run games
            for (let i = 0; i < gameCount; i++) {
                try {
                    const result = await runSingleGame(playerCount);
                    processGameResult(result);
                    updateUI();

                    // Update progress
                    const progress = ((i + 1) / gameCount * 100).toFixed(0);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';

                    // Allow UI to update
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                } catch (error) {
                    log(`‚ùå Error in game ${i + 1}: ${error.message}`, 'error');
                }
            }

            log(`‚úÖ Simulation complete! ${gameCount} games finished.`, 'success');
            isRunning = false;
            btnRunSim.disabled = false;
            btnRunSim.innerHTML = '‚ñ∂Ô∏è Run Simulation';
            document.getElementById('detailedStats').classList.remove('hidden');
        }

        // Run a single game
        async function runSingleGame(playerCount) {
            // Create players
            const players = [];
            for (let i = 1; i <= playerCount; i++) {
                players.push(createPlayer(i));
            }

            // Select 8 random events
            const shuffledEvents = [...gameData.events].sort(() => Math.random() - 0.5);
            const gameEvents = shuffledEvents.slice(0, 8);

            // Create markets
            let heroMarket = [...gameData.heroes].sort(() => Math.random() - 0.5).slice(0, 6);
            let titleMarket = [...gameData.titles].sort(() => Math.random() - 0.5).slice(0, playerCount + 2);

            // Run 8 turns
            for (let turn = 1; turn <= 8; turn++) {
                // Deploy phase (simplified - random deployment)
                for (const player of players) {
                    deployRandomly(player);
                }

                // Purchase phase
                for (const player of players) {
                    const result = purchaseManager.executePurchase(
                        player,
                        heroMarket,
                        titleMarket,
                        { turn, phase: 'purchase' }
                    );

                    if (result.success && result.action === 'hero') {
                        // Remove purchased hero from market
                        heroMarket = heroMarket.filter(h => h.id !== result.target.id);
                    } else if (result.success && result.action === 'title') {
                        // Remove purchased title from market
                        titleMarket = titleMarket.filter(t => t.id !== result.target.id);
                    }
                }

                // Cleanup phase - refill markets
                const remainingHeroes = gameData.heroes.filter(h => 
                    !heroMarket.some(mh => mh.id === h.id) &&
                    !players.some(p => [...p.hand, ...p.battlefield.wei, ...p.battlefield.wu, ...p.battlefield.shu].some(ph => ph.id === h.id))
                );
                heroMarket = [...heroMarket, ...remainingHeroes.sort(() => Math.random() - 0.5).slice(0, 4 - heroMarket.length)];

                const remainingTitles = gameData.titles.filter(t => 
                    !titleMarket.some(mt => mt.id === t.id) &&
                    !players.some(p => p.titles.some(pt => pt.id === t.id))
                );
                titleMarket = [...titleMarket, ...remainingTitles.sort(() => Math.random() - 0.5).slice(0, (playerCount + 2) - titleMarket.length)];
            }

            // Calculate final scores
            const finalScores = purchaseManager.calculateFinalScores(players, gameEvents);

            return { players, finalScores, gameEvents };
        }

        // Create a player
        function createPlayer(id) {
            // Give starting peasants
            const peasants = [
                { id: 9001, name: 'Peasant (Military)', military: 2, influence: 0, supplies: 0, piety: 0, roles: [], allegiance: 'None', effects: '', set: 'Peasant' },
                { id: 9002, name: 'Peasant (Influence)', military: 0, influence: 2, supplies: 0, piety: 0, roles: [], allegiance: 'None', effects: '', set: 'Peasant' },
                { id: 9003, name: 'Peasant (Supplies)', military: 0, influence: 0, supplies: 2, piety: 0, roles: [], allegiance: 'None', effects: '', set: 'Peasant' },
                { id: 9004, name: 'Peasant (Piety)', military: 0, influence: 0, supplies: 0, piety: 2, roles: [], allegiance: 'None', effects: '', set: 'Peasant' }
            ];

            return {
                id,
                hand: [...peasants],
                battlefield: { wei: [], wu: [], shu: [] },
                retired: [],
                titles: [],
                score: 0,
                emergencyUsed: 0
            };
        }

        // Deploy heroes randomly
        function deployRandomly(player) {
            const kingdoms = ['wei', 'wu', 'shu'];
            const availableHeroes = player.hand.filter(h => h.id < 9000); // Not peasants
            
            // Deploy up to 3 heroes
            const deployCount = Math.min(3, availableHeroes.length);
            for (let i = 0; i < deployCount; i++) {
                const hero = availableHeroes[i];
                const kingdom = kingdoms[Math.floor(Math.random() * kingdoms.length)];
                
                // Remove from hand
                player.hand = player.hand.filter(h => h.id !== hero.id);
                
                // Add to battlefield
                player.battlefield[kingdom].push({ ...hero, kingdom });
            }
        }

        // Process game result
        function processGameResult(result) {
            simulationStats.gamesCompleted++;

            // Find winner
            const sortedPlayers = Object.entries(result.finalScores)
                .sort((a, b) => b[1].finalScore - a[1].finalScore);
            const winner = sortedPlayers[0];
            
            simulationStats.winsByPosition[parseInt(winner[0])]++;

            // Track scores
            for (const [playerId, scoreData] of Object.entries(result.finalScores)) {
                simulationStats.totalScores.push(scoreData.finalScore);
                simulationStats.emergencyUsage.push(scoreData.emergencyPenalty * -1);

                // Track title acquisitions
                for (const titleName of scoreData.titlesAcquired) {
                    simulationStats.titleAcquisitions[titleName] = 
                        (simulationStats.titleAcquisitions[titleName] || 0) + 1;
                }
            }
        }

        // Update UI with stats
        function updateUI() {
            const stats = simulationStats;
            
            document.getElementById('gamesCompleted').textContent = stats.gamesCompleted;

            if (stats.totalScores.length > 0) {
                const avgScore = (stats.totalScores.reduce((a, b) => a + b, 0) / stats.totalScores.length).toFixed(1);
                document.getElementById('avgScore').textContent = avgScore;

                const avgEmergency = (stats.emergencyUsage.reduce((a, b) => a + b, 0) / stats.emergencyUsage.length).toFixed(1);
                document.getElementById('avgEmergency').textContent = avgEmergency;

                // Win rate for P1
                const winRateP1 = ((stats.winsByPosition[1] / stats.gamesCompleted) * 100).toFixed(1);
                document.getElementById('winRateP1').textContent = winRateP1 + '%';

                // Win rate breakdown
                const breakdown = document.getElementById('winRateBreakdown');
                breakdown.innerHTML = '';
                for (const [position, wins] of Object.entries(stats.winsByPosition)) {
                    const winRate = ((wins / stats.gamesCompleted) * 100).toFixed(1);
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-label">Player ${position}</div>
                        <div class="stat-value">${winRate}%</div>
                    `;
                    breakdown.appendChild(card);
                }

                // Title stats
                const titleStatsDiv = document.getElementById('titleStats');
                titleStatsDiv.innerHTML = '';
                const sortedTitles = Object.entries(stats.titleAcquisitions)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 20); // Top 20

                for (const [title, count] of sortedTitles) {
                    const rate = ((count / stats.gamesCompleted) * 100).toFixed(0);
                    const item = document.createElement('div');
                    item.className = 'title-item';
                    item.innerHTML = `
                        <div class="title-name">${title}</div>
                        <div class="title-stats">${count} acquisitions (${rate}%)</div>
                    `;
                    titleStatsDiv.appendChild(item);
                }
            }
        }

        // Clear results
        function clearResults() {
            simulationStats = {
                gamesCompleted: 0,
                totalScores: [],
                winsByPosition: {},
                emergencyUsage: [],
                titleAcquisitions: {}
            };
            
            document.getElementById('gamesCompleted').textContent = '0';
            document.getElementById('avgScore').textContent = '-';
            document.getElementById('winRateP1').textContent = '-';
            document.getElementById('avgEmergency').textContent = '-';
            document.getElementById('winRateBreakdown').innerHTML = '';
            document.getElementById('titleStats').innerHTML = '';
            document.getElementById('detailedStats').classList.add('hidden');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            log('Results cleared', 'info');
        }

        // Event listeners
        btnLoadData.addEventListener('click', loadGameData);
        btnRunSim.addEventListener('click', runSimulation);
        btnClearResults.addEventListener('click', clearResults);

        // Initial log
        log('Monte Carlo Simulator initialized', 'info');
        log('Click "Load Game Data" to begin', 'info');
    </script>
</body>
</html>
